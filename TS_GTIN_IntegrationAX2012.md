# ТЕХНИЧЕСКОЕ ЗАДАНИЕ
## Расширение функционала маркировки товаров: интеграция данных GTIN из Infor

**Версия:** 1.0  
**Дата:** 23.12.2025  
**Система:** Microsoft Dynamics AX 2012  
**Модуль:** Маркировка продукции, Интеграция RabbitMQ-Infor, Обмен по ЭДО  

---

## 1. ТРЕБОВАНИЯ

### 1.0 Обозначения

В данном документе используются следующие обозначения:

- **«Принимать GTIN из Infor как ОСУ»** = `MPProductGroup.isAcceptGTINFromInfor`
- **«Новый параметр»** = **«Параметр»** = `MPProductGroup.isAcceptGTINFromInfor`
- **«GTIN из Infor»** = `MPSalesPurchMarkCodeTable.GTINFromInfor`
- **«Выбытие из организации»** = `InventTable.RetirementFromLegalEntity`
- **«Объёмно-сортовой учет для продаж»** = `InventTable.MPVolumeAndVarietalAccSales`
- **«ОСУ для продаж»** = **«Объёмно-сортовой учет для продаж»** = `InventTable.MPVolumeAndVarietalAccSales`
- **«признак ОСУ»** = **«Объёмно-сортовой учет для продаж»** = `InventTable.MPVolumeAndVarietalAccSales`
- **«признак ОСУ/выбытия»** = наличие хотя бы одного из признаков: **«Выбытие из организации»** (`InventTable.RetirementFromLegalEntity`) **или** **«Объёмно-сортовой учет для продаж»** (`InventTable.MPVolumeAndVarietalAccSales`). Для применения параметра «Принимать GTIN из Infor как ОСУ» достаточно установки **одного** из этих признаков; не требуется одновременная установка обоих признаков в значение ДА.
  - **Важно:** Признаки **«Выбытие из организации»** и **«Объёмно-сортовой учет для продаж»** являются взаимоисключающими: они не могут быть одновременно установлены в значение ДА. Должен быть установлен ровно один из них (либо **«Выбытие из организации»** = ДА, либо **«Объёмно-сортовой учет для продаж»** = ДА). Проверка выполняется на уровне таблицы InventTable в методе validateWrite.
- **ПУ** = партионный учет

### 1.1 Бизнес-контекст
Развитие проекта интеграции с X5 по части передачи данных фактических кодов объёмно-сортового учёта (ОСУ, GTIN). Система должна обрабатывать входящие сообщения из Infor об отгрузке товаров с указанием GTIN-кодов и отражать эту информацию в документах УПД (Универсальный передаточный документ) и ИУПД (Исправительная УПД) для заказов на продажу.

### 1.2 Основные бизнес-требования

#### 1.2.1 Параметризация товарных групп
Создать дополнительный параметр в товарных группах модуля «Маркировка продукции» таблицы MPProductGroup для управления обработкой GTIN:

- **Параметр:** «Принимать GTIN из Infor как ОСУ» название isAcceptGTINFromInfor (тип: Yes/No)
- **Место:** Меню → Маркировка продукции → Настройка → Товарные группы Вкладка Настройка, новая группа полей "Обработка GTIN из Инфор" после вкладок "Дополнительно" и "Движение марок" как третья колонка
- **Назначение:** 
  - Если = **Нет**: Запретить обработку GTIN для этой группы. При поступлении GTIN из Infor выводить информацию в зависимости от настроек в реквизите таблицы MPParameters.MPCodeCustInvoiceCheckType (Предупреждение/Ошибка/Нет) на стадии разноски документа или в реквизите MPParameters.MPCodeCustPickingListCheckType (Предупреждение/Ошибка/Нет) при обработке очереди Rabbit.
  
  **Паттерн использования уровня проверки:**
  
  В определении переменных метода:
  ```x++
  public boolean checkMPCode(boolean _showBox = false, boolean _throw = false)
  {
      MPCodeCheckType checkType = MPParameters::find().MPCodeCustInvoiceCheckType; // для разноски УПД и исправительных накладных клиента
      // или
      MPCodeCheckType checkType = MPParameters::find().MPCodeCustPickingListCheckType; // при обработке очереди Rabbit
  ```
  
  В начале реализации метода проверки:
  ```x++
      if (checkType == MPCodeCheckType::NoCheck)
      {
          return true;
      }
  ```
  
  В месте применения проверки:
  ```x++
              if (checkType == MPCodeCheckType::Warning)
                  warning(strFmt("@MIK9004", localSalesTable.SalesId, errorStr));
              else
              {
                  error(strFmt("@MIK9004", localSalesTable.SalesId, errorStr));
                  if (_throw)
                      throw error("@SYS21533");
              }
  ```
  
  Пример использования: метод `checkMPCode` класса `SalesFormletterParmDataInvoice` для разноски УПД и исправительных накладных клиента, метод `checkMPCode` класса `SalesFormletterParmDataPickingList` при обработке очереди Rabbit.
  
  - Если = **Да**: Разрешить приём и обработку GTIN-данных как ОСУ для всей цепочки обработки (от входящих XML до УПД).
- **Область действия:** Распространяется на все текущие и новые товарные группы.
- **Условия применения:**
  - Применяется только если в карточке товара установлен признак «Объёмно-сортовой учет для продаж» InventTable.MPVolumeAndVarietalAccSales или «Выбытие из организации» InventTable.RetirementFromLegalEntity
  - Не влияет на обработку традиционных марок (ПУ).

#### 1.2.2 Расширение таблицы маркировки по заказам
Добавить новое поле в таблицу «Коды маркировки по заказам» (MPSalesPurchMarkCodeTable):

- **Новое поле:** «GTIN из Infor» название GTINFromInfor  (создать новый EDT GTINFromInfor на базе EDT GlobalTradeItemNumber)
- **Назначение:** Хранение GTIN-кодов, полученных из Infor для данной строки заказа на продажу
- **Путь доступа к таблице:**
  - Основной: Меню → Маркировка продукции → Обычный → Коды маркировок по заказам
  
#### 1.2.3 Обработка входящих сообщений из Infor
Модифицировать пакеты обработки входящих событий отгрузки:

- **События:** ordershipped9, dropidshipped9, customerorderpacked9, dropidpacked9
- **Класс обработки**  наследники класса RabbitIntEngineImp_Infor
  - ordershipped9 Класс RabbitIntEngineImp_Infor_Shipped (Отгрузка товара Infor)
  - dropidshipped9 Класс RabbitIntEngineImp_Infor_ShippedPart (Частичная отгрузка товара Infor)
  

**Структура XML (раздел DropIdDetail):** вместо тегов `<HS_MARK>` и `<HS_MARK_TYPE>` используется тег `<GTIN>`:
- Пустой тег: `<GTIN />`
- Заполненный тег: `<GTIN>04630000922727</GTIN>`
- Если товар отгружается по ОСУ, тег `<GTIN>` должен быть заполнен.
- Если товар отгружается не по ОСУ, а как ПУ, тег `<GTIN>` должен быть пустым; по этому SKU передать марки в ЧЗ части DropIdDetail.

**Алгоритм обработки построчно (по номенклатурам) в XML:**

1. **Чтение тега GTIN:** Вычитать значение тега `<GTIN>` для каждой строки товара в разделе DropIdDetail (пусто или значение GTIN).
2. **Условия обработки GTIN** (если тег `<GTIN>` заполнен):
   - Проверить в карточке товара наличие признака ОСУ/выбытия (хотя бы один из: «Объёмно-сортовой учет для продаж» или «Выбытие из организации»)
   - Если товар НЕ имеет признака ОСУ/выбытия (отсутствуют оба признака): работать по существующему алгоритму ПУ; в поле «GTIN из Infor» для такого товара не писать (обработка по аналогии с кодами маркировки: АХ вычитывает XML, проводит все проверки, при успешном прохождении пишет данные по кодам маркировки и GTIN в таблицу MPSalesPurchMarkCodeTable)
   - Если товар ИМЕЕТ признак ОСУ/выбытия (хотя бы один из признаков присутствует):
     - Проверить параметр «Принимать GTIN из Infor как ОСУ» в товарной группе
     - Если параметр не установлен: выбросить ошибку «По заказу %1 на товар %2 прислан GTIN. По товарной группе %3 движение по ОСУ запрещено.» (метка @MIK14632). Применение проверки выполняется по паттерну уровня проверки (см. раздел 1.2.1) с использованием `MPCodeCheckType checkType = MPParameters::find().MPCodeCustPickingListCheckType` в методах обработки очереди Rabbit (классы RabbitIntEngineImp_Infor и их наследники)
     - Если параметр установлен: перейти к обработке GTIN
3. **Валидация GTIN** (при обработке заполненного тега `<GTIN>`):
   - Проверить формат: числовое значение, 14 символов (стандарт EAN/UCC-14)
   - При ошибке формата: выбросить ошибку вида «В заказе %1 значение GTIN %2 по артикулу %3 не соответствует формату EAN/UCC-14» (метка @MIK14633)
4. **Подсчёт данных по SKU при обработке:**
   - Посчитать в XML количество подходящих под обработку `<SKU>` (строк по одному артикулу к отгрузке)
   - Если артикул к отгрузке в XML один: продолжить проверки и обработку дальше
   - Если артикулов к отгрузке в XML больше одного: проверить тег `<GTIN></GTIN>` по каждому вхождению SKU
   - Если по одному SKU в XML несколько строк (например, 2): один с заполненным `<GTIN>`, другой с пустым `<GTIN>` — выбросить ошибку «По заказу %1 на товар %2 присланы не все GTIN. Смешанная отгрузка товара запрещена.» (уровень определяется настройкой разноски и активацией модификаций)
   - Если по одному SKU в XML несколько строк, у обоих `<GTIN>` заполнены, но значения отличаются — выбросить ошибку «По заказу %1 на товар %2 присланы не все GTIN. Отгрузка товара смешанного учёта запрещена.» (уровень определяется настройкой разноски и активацией модификаций)
5. **Проверка наличия в базе** (при заполненном теге `<GTIN>`):
   - Получить InventTable через InventTable::findItemId_Infor(SKU) (метод существует в системе), где SKU из тега <SKU> соответствует полю ItemId_Infor в InventTable
   - Найти запись в таблице InventItemGTIN по ItemId = InventTable.ItemId (полученного через существующий метод InventTable::findItemId_Infor(SKU))
   - Получить значение GTIN из реквизита InventItemGTIN.GlobalTradeItemNumber
   - Сравнить полученный GTIN из InventItemGTIN.GlobalTradeItemNumber со значением GTIN из тега `<GTIN>`
   - При отсутствии записи в InventItemGTIN или несовпадении GTIN: вывести ошибку «GTIN %1 отсутствует в таблице “Коды GTIN” по артикулу %2, заказ %3» (метка  @MIK14634). Применение проверки выполняется по паттерну уровня проверки (см. раздел 1.2.1) с использованием `MPCodeCheckType checkType = MPParameters::find().MPCodeCustPickingListCheckType` в методах обработки очереди Rabbit (классы RabbitIntEngineImp_Infor и их наследники)
6. **Запись данных:** сначала все проверки всего, затем уже запись
   - Записать GTIN из тега `<GTIN>данные</GTIN>` в новое поле «GTIN из Infor» таблицы MPSalesPurchMarkCodeTable
   - Если SKU в XML один: записать количество из тега `<Qty>` в поле «Количество содержимого» таблицы MPSalesPurchMarkCodeTable
   - Если SKU в XML больше одного: просуммировать и записать количество из тегов `<Qty>` в поле «Количество содержимого» таблицы MPSalesPurchMarkCodeTable
   - В одной строке поля «GTIN из Infor» и «Код маркировки» не должны быть заполнены вместе
7. **Обработка других значений (пустой тег `<GTIN>` или `<GTIN />`):**
   - Если `<GTIN></GTIN>` (пусто) и по SKU в разделе DropIdDetail нет информации: работать по существующим алгоритмам — как неподконтрольный ЧЗ товар
   - Если `<GTIN></GTIN>` (пусто), но по SKU в разделе DropIdDetail есть информация: работать по существующим алгоритмам — как ПУ

**Уточняющие проверки при обработке:**

- **Проверка #1 - Запрет смешивания типов учёта:** 
  - Один и тот же товар (SKU) в одном заказе на продажу НЕ может быть отгружен одновременно с марками (ПУ) и с GTIN (ОСУ), то есть, по одному SKU не допускается сочетание заполненного и пустого тега `<GTIN>` в разных строках (учёт смешанной отгрузки — см. пункт 4 алгоритма)
  - Ошибка: «В заказе %1 на артикул %2 указано больше одного вида учёта: и ПУ (марки), и ОСУ (GTIN)» (метка @MIK14635)

- **Проверка #2 - Количество GTIN на товар в заказе:** 
  - В одном заказе для одного SKU может быть только **ОДИН GTIN** (возможно, условие может измениться при уточнении УОУ требований по формированию УПД)
  - Если в XML на один SKU прислали ДВА и более GTIN, то брать первый и проводить проверки по первому
  - o	Если в XML на один SKU прислали ДВА и более GTIN, то логировать эту информацию в журнале: «Зафиксировано наличие 2 и более GTIN на 1 SKU: заказ %1, SKU %2, GTIN %3» (метка @MIK14636)
- **Проверка #3 - Запрет на обработку без параметра:**
  - Если «Параметр» = Нет, а товар имеет признак ОСУ/выбытия, и из Infor пришёл GTIN (тег `<GTIN>` заполнен), то применяется паттерн уровня проверки (см. раздел 1.2.1):
    - В определении переменных: `MPCodeCheckType checkType = MPParameters::find().MPCodeCustPickingListCheckType;` (в методах обработки очереди Rabbit)
    - В начале метода: `if (checkType == MPCodeCheckType::NoCheck) { return true; }`
    - В месте применения проверки:
      - При `checkType == MPCodeCheckType::Warning`: вывести предупреждение через `warning()`, продолжить обработку
      - При `checkType == MPCodeCheckType::Mistake` (Ошибка): вывести ошибку через `error()`, при необходимости выбросить исключение через `throw error()`, остановить обработку
  
#### 1.2.4 Формирование УПД с учётом GTIN
Модифицировать пакет формирования УПД для заказов на продажу:

- **Место формирования:** Документы к выгрузке → Исходящий пакет документов по накладным (продажи)
- **Условия формирования:**
- **Класс обработки:**  XMLExcelReport_UTD_XML метод addKIZ также наследники этого класса где перекрыт этот метод
  1. Если товар не имеет «признака ОСУ/выбытия»: работать по существующему алгоритму ПУ
  2. Если товар имеет признак ОСУ/выбытия (хотя бы один из: «Выбытие из организации» или «Объёмно-сортовой учет для продаж»), но «Параметр» = Нет:
     - Проверить наличие GTIN в поле «GTIN из Infor» в таблице MPSalesPurchMarkCodeTable
     - Если GTIN найден: выбросить ошибку «В заказе %1 по артикулу %2 обнаружен GTIN, по товарной группе %3 отражение GTIN в УПД запрещено»
     - Если GTIN не найден: работать по существующему алгоритму ПУ
  3. Если товар имеет признак ОСУ/выбытия (хотя бы один из: «Выбытие из организации» или «Объёмно-сортовой учет для продаж») и «Параметр» = Да:
     - Проверить наличие значения в поле «GTIN из Infor»
     - Если значение есть: формировать УПД в режиме ОСУ
       - В тег ГТИН записать значение из «GTIN из Infor»
       - В тег КолВедМарк записать количество из поля «Количество содержимого» таблицы MPSalesPurchMarkCodeTable
     - Если значение отсутствует (пусто): формировать УПД в режиме ПУ (по существующему алгоритму с марками)

**Дополнительные проверки при формировании УПД:**

- **Проверка #1 - Запрет смешивания типов в документе:**
  - Один товар в одном заказе не может быть отражён одновременно как ПУ, ОСУ и GTIN
  - Ошибка: «В заказе %1 на артикул %2 указано больше одного вида учёта: и ПУ (марки), и ОСУ (GTIN)» (метка @MIK14635)

- **Проверка #2 - Уникальность GTIN:**
  - Для одного SKU в заказе может быть только один GTIN (согласно правилам УПД)

#### 1.2.5 Обработка исправительных накладных
Модифицировать функционал внесения изменений (исправительных накладных) в финансовую накладную:
**Класс обработки** SalesFormletterParmDataInvoice метод checkMPCode Возможно класс SalesFormletterParmDataPickingList метод checkMPCode
- **Сценарий:** При изменении количества в исправительной накладной (Ис-*) проверить:
  1. Если товар НЕ имеет признака ОСУ/выбытия (отсутствуют оба признака: нет «ОСУ для продаж» и нет «Выбытие из организации»): работать по существующему алгоритму
  2. Если товар имеет признак ОСУ/выбытия, но «Параметр» = Нет: работать по существующему алгоритму
  3. Если «Параметр» = Да:
     - Выполнить поиск товара в таблице MPSalesPurchMarkCodeTable по:
       - Номеру заказа на продажу
       - Связь через финансовую накладную к отгрузочной накладной
     - Если в таблице заполнено поле «Код маркировки» (MPCode): работать по алгоритму ПУ
     - Если заполнено поле «GTIN из Infor»: выполнить корректировку поля «Количество содержимого»
     - Если оба поля пусты: работать по существующему алгоритму


#### 1.2.6 Формирование ИУПД
Модифицировать алгоритм формирования ИУПД аналогично пункту 1.2.4 (УПД):
- Применить те же условия и проверки
- Учитывать «Новый параметр» в товарной группе
- Обеспечить корректное отражение GTIN и количества в исправительном документе

#### 1.2.7 Обновление статусов маркировки в заказах на продажу
**Класс обработки** MPActionFormRefreshMarkingStatus
Модифицировать периодическую операцию обновления статусов маркировки:

- **Место:** Меню → Маркировка продукции → Периодические операции → Обновление статусов маркировок в заказах на продажу
- **Условия обновления:**
  - Включить новые условия с учётом данных в поле «GTIN из Infor»
  - Актуальные статусы для продаж:
    - **Немаркируемый товар**: В строках заказа отсутствует признак ОСУ/выбытия (нет ни «Выбытия из организации», ни «Объёмно-сортового учёта для продаж»)
    - **Не загружены маркировки**: Товар имеет признак, но сигналы из Infor не обработаны или обработаны без результата
    - **Загружены частично маркировки**: Значение поля «Количество содержимого» (AgregationCount) в таблице не совпадает с количеством в накладной
    - **Загружены маркировки из ВС**: Сигналы обработаны успешно, данные записаны, значение поля «Количество содержимого» (AgregationCount) совпадает (финальный статус)
  - Применить ту же логику для GTIN: если заполнено поле «GTIN из Infor» и значение поля «Количество содержимого» (AgregationCount) совпадает, установить финальный статус

#### 1.2.8 Разноска накладных с проверками
Модифицировать классы разноски накладных с учётом новых параметров:
SalesFormletterParmDataInvoice.checkMPCode
PurchFormletterParmDataInvoice.checkMPCode
SalesFormletterParmDataPickingList.checkMPCode
- **Место параметров:** Форма → Параметры маркировки продукции
- **Затронутые поля:** 
  - «Проверка накладных продаж» (MPCodeCustInvoiceCheckType)
  - «Проверка отгрузочных накладных» (MPCodeCustPickingListCheckType)
- **Значения (уровни проверки):**
  - **Нет** (MPCodeCheckType::NoCheck): Проверки не проводятся, накладные разносятся
  - **Предупреждение** (MPCodeCheckType::Warning): Проверки проводятся, ошибки пишутся в лог, накладные разносятся
  - **Ошибка** (MPCodeCheckType::Mistake): Проверки проводятся, ошибки пишутся в лог, накладные НЕ разносятся
- **Паттерн использования:** Применяется единый паттерн уровня проверки (см. раздел 1.2.1):
  - В определении переменных метода: `MPCodeCheckType checkType = MPParameters::find().MPCodeCustInvoiceCheckType;` для разноски УПД и исправительных накладных клиента
  - В начале реализации метода проверки: `if (checkType == MPCodeCheckType::NoCheck) { return true; }`
  - В месте применения проверки: использование `if (checkType == MPCodeCheckType::Warning)` для предупреждений и `else` блока с `error()` и `throw error()` для ошибок
- **Новые проверки при разноске:**
  - Проверить соответствие параметра товарной группы при наличии GTIN
  - Проверить формат GTIN (14 цифр, EAN/UCC-14)
  - Проверить запрет на смешивание типов учёта (ПУ + GTIN)
  - Применить все проверки к указанному уровню разноски по единому паттерну

---

## 2. СООТВЕТСТВИЯ И НАВИГАЦИЯ

### 2.1 Навигация по объектам AX

| № | Компонент | Путь навигации | Форма/Таблица | Роль/Область |
|----|-----------|----------------|---------------|--------------|
| 1 | Товарные группы (параметры) | Меню → Маркировка продукции → Настройка → Товарные группы | MPProductGroup | Администратор маркировки |
| 2 | Коды маркировки по заказам | Меню → Маркировка продукции → Обычный → Коды маркировок по заказам | MPSalesPurchMarkCodeTable | Пользователь SLAT |
| 3 | Заказы на продажу (ЧЗ) | Меню → SLAT/Расчеты с клиентами → Обычный → Заказы на продажу → Все заказы на продажу → Разное → Честный Знак | SalesTable, MPSalesPurchMarkCodeTable | Менеджер продаж |
| 4 | Входящие сообщения Infor | Меню → Integration → Периодические операции → Интеграция с RabbitMQ → Журналы → Очередь RabbitMQ | IOIncomingQueue, IOIncomingHeader | Администратор интеграции |
| 5 | Параметры маркировки | Меню → Маркировка продукции → Настройка → Параметры маркировки продукции | MPParameter | Администратор модуля |
| 6 | Документы к выгрузке (УПД) | Меню → Маркировка продукции → Обычный → Документы к выгрузке | IOOutgoingQueue, IOOutgoingHeader | Администратор ЭДО |
| 7 | Обновление статусов маркировок | Меню → Маркировка продукции → Периодические операции → Обновление статусов маркировок в заказах на продажу | Пакет обновления (RUN) | Администратор |

### 2.2 Существующие объекты AX (переиспользование)

| Объект AX | Тип | Назначение в ТЗ | Примечания |
|-----------|-----|-----------------|-----------|
| InventTable | Таблица | Чтение признаков «Объёмно-сортовой учет для продаж», «Выбытие из организации», товарной группы (MPGroupId). Связь с MPProductGroup через MPGroupId. Метод InventTable::findItemId_Infor(SKU) существует и используется для поиска товара по SKU из Infor | Карточка товара |
| InventItemGTIN | Таблица | Проверка наличия существующего GTIN. Поиск по InventTable.ItemId, получение GTIN из реквизита InventItemGTIN.GlobalTradeItemNumber | Проверка соответствия GTIN из Infor с GTIN в базе данных |
| SalesTable | Таблица | Чтение номера заказа, связей с накладными | Заказ на продажу |
| MPSalesPurchMarkCodeTable | Таблица | **Расширение:** добавить новое поле «GTIN из Infor» | Коды маркировок по заказам |
| MPParameter | Таблица | Чтение уровней проверки разноски (поля «Проверка накладных продаж», «Проверка отгрузочных накладных») | Параметры маркировки |
| IOIncomingQueue, IOIncomingHeader | Таблицы | Получение входящих сообщений из Infor (ordershipped9 и др.) | Интеграция RabbitMQ |
| IOOutgoingQueue, IOOutgoingHeader | Таблицы | Запись исходящих УПД/ИУПД | Обмен по ЭДО |
| MPProductGroup | Таблица | **Расширение:** добавить параметр «Принимать GTIN из Infor как ОСУ». Связь с товаром через InventTable.MPGroupId | Товарные группы модуля маркировки |

### 2.3 Новые объекты AX

| Объект | Тип | Структура | Назначение |
|--------|-----|-----------|-----------|
| Поле в MPProductGroup | Поле таблицы | String, 1 символ (Yes/No enum) | Параметр управления обработкой GTIN по товарной группе |
| Поле в MPSalesPurchMarkCodeTable | Поле таблицы | String, 14 символов (по аналогии с полем «Код GTIN») | Хранение GTIN из Infor для каждой строки маркировки по заказу |

---

## 3. РЕШЕНИЕ

### 3.1 Интерфейс (Формы и UI)

#### 3.1.1 Форма Товарные группы (MPProductGroup) — Расширение

**Изменение:** Добавить «Новый параметр» на форму

- **Место:** Форма товарной группы, вкладка/блок параметров маркировки
- **Новое поле:** 
  - Название: «Принимать GTIN из Infor как ОСУ»
  - Тип: Checkbox (Yes/No)
  - Размещение: После существующих параметров маркировки (например, после признаков ПУ/ОСУ)
  - Справка: «Если отмечено, система будет обрабатывать входящие данные GTIN из Infor как объёмно-сортовой учёт»
- **Доступ:** Администратор маркировки

**Примечание:** Параметр должен распространяться на все текущие и новые товарные группы (инициализировать значение = Нет для существующих).

#### 3.1.2 Форма Коды маркировок по заказам (MPSalesPurchMarkCodeTable) — Расширение

**Расширение поля таблицы и формы "Создать" (MPCreateOrUpdateMarkCodeTableNewRunBase)**

**Новое поле в таблице:**
- Название: «GTIN из Infor»
- Тип: EDT GTINFromInfor
- Видимость: На всех формах отображения таблицы
- Размещение: После поля «Код GTIN»

**Модификация формы "Создать" для Добавить чекбокс «GTIN из Infor»:**
   - Разместить под строкой «Агрегированный код»
   - При выборе: активирует новое поле ввода GTIN из Infor и отключает поля марок/агрегированного кода

**Добавить поле ввода «GTIN из Infor»:**
   - Разместить под новым чекбоксом
   - Поведение:
     - Если чекбокс = Нет (неотмечен): поле неактивно (заблокировано)
     - Если чекбокс = Да (отмечен): поле активно для редактирования и обязательно к заполнению
   - Тип ввода: числовой, 14 символов, с поддержкой вставки (Ctrl+V)
   - Валидация: Проверка формата EAN/UCC-14 при записи (14 цифр). Ошибка: «В заказе %1 значение GTIN %2 по артикулу %3 не соответствует формату: числовой и/или EAN/UCC-14 знаков»

**Взаимное исключение полей:**
   - Если чекбокс «GTIN из Infor» = Да:
     - Поля «Код маркировки» и «Агрегированный код» блокируются (становятся неактивными)
     - Содержимое этих полей либо очищается, либо игнорируется при создании записи
     - Чекбокс «Агрегация» не может быть установлен в значение Да одновременно с GTIN

**Добавить поле «Количество содержимого»:**
   - Разместить под строкой «Единица измерения»
   - Тип: числовой, обязательное поле
   - Поведение:
     - Если значение = 0: система автоматически возьмёт количество из первой накладной продажи по этому заказу и товару
     - Если значение > 0: должно совпадать с количеством в текущей накладной (финансовой или последней исправительной), иначе ошибка «Количество должно совпадать с текущим значением финансовой накладной»
   - Это поле используется как для GTIN, так и для классических кодов маркировки

**Автозаполнение полей при создании (по нажатию кнопки ОК):**
   - **Код товарной группы (ProductGroupId):** Брать из карточки товара (InventTable.MPGroupId)
   - **Маршрут комплектации (PickingRouteID):** Брать номер УПД из шапки заказа на продажу (SalesTable.CustUTDNum)

**Исправить существующие недоработки:**
   - Проблема: Если заполнены «Код маркировки» и/или «Агрегированный код» с чекбоксом «Агрегация = Да», поле «Наименование продукта из файла» (ProductName) не заполняется (должно заполняться)
   - Решение: Обеспечить заполнение поля ProductName наименованием товара независимо от статуса Агрегация
**Решение:**
ProductName берем из метода defaultProductName таблицы InventTable.defaultProductName

#### 3.1.3 Кнопка «Заменить GTIN из Infor по строке» (Доп. задача)

**Место:** Форма Коды маркировок по заказам (MPSalesPurchMarkCodeTable)

**Условия активации кнопки:**
- Кнопка активна (видима и кликабельна), если:
  - Поле «Приход/Расход» = «Продажи»
  - Поле «GTIN из Infor» НЕ пусто

**Функциональность открываемой формы:**

При нажатии кнопки откроется диалоговая форма со следующими полями:

1. **Приход/Расход** (заблокировано) — содержит текущее значение из строки
2. **Номер заказа** (заблокировано) — содержит текущее значение из строки
3. **Текущий GTIN из Infor** (заблокировано) — содержит текущее значение из поля
4. **Новый GTIN из Infor** (редактируемое) — поле ввода нового GTIN
5. **Кнопка "ОК"** — сохранить новое значение
6. **Кнопка "Отмена"** — закрыть диалог без изменений

**Валидация:**
- При сохранении проверить формат нового GTIN (14 цифр, EAN/UCC-14)
- Ошибка при неверном формате: «В заказе %1 значение GTIN %2 по артикулу %3 не соответствует формату: числовой и/или EAN/UCC-14 знаков»

### 3.2 Данные (Таблицы и структуры)

#### 3.2.1 Расширение таблицы MPProductGroup

**Новое поле:**

```
Имя поля: isAcceptGTINFromInfor (или аналогичное)
Тип: Enum (NoYes)
Метка: Принимать GTIN из Infor как ОСУ
Справка: Если отмечено, система будет обрабатывать входящие данные GTIN из Infor как объёмно-сортовой учёт для данной товарной группы
Обязательное: Нет
Значение по умолчанию: Нет
```

**Связь с товаром:** Параметр доступен через связь InventTable.MPGroupId → MPProductGroup.GroupId. Для получения значения параметра использовать существующий метод MPProductGroup::findByGroupId(InventTable.MPGroupId).isAcceptGTINFromInfor

**Инициализация существующих групп:** Установить значение Нет для всех текущих записей.

#### 3.2.2 Расширение таблицы MPSalesPurchMarkCodeTable

**Новое поле:**

```
Имя поля: GTINFromInfor
Тип: EDT GTINFromInfor
Метка: GTIN из Infor (мерка @MIK14637)
Справка: GTIN-код, полученный из системы Infor в рамках интеграции (метка @MIK14638)
Обязательное: Нет (может быть пусто)
Индексирование: Рекомендуется индекс по (SalesId, ItemId, GTINFromInfor) для оптимизации запросов
```

**Влияние на существующие структуры:** Добавление поля не нарушает существующие связи и индексы таблицы.

#### 3.2.3 Структура данных при обработке входящего XML

**Пример входящего XML (Infor):**

```xml
<DropIdDetail>
  <OrderKey>SO22788205</OrderKey>
  <DropId>DRSO2278820501</DropId>
  <SKU>10036859</SKU>
  <ConsigneeKey>000034609</ConsigneeKey>
  <Qty>24.0</Qty>
  <InventBatchId>AAATIQT342</InventBatchId>
  <GTIN>04605622010238</GTIN>
</DropIdDetail>
```

Пустой тег для отгрузки по ПУ: `<GTIN />`

**Соответствие в AX:**
- SKU → InventTable.ItemId_Infor (поиск через существующий метод InventTable::findItemId_Infor(SKU))
- GTIN → Значение GTIN (запись в GTINFromInfor); пустой тег — отгрузка по ПУ, марки в ЧЗ части DropIdDetail
- Qty → Количество (запись в поле «Количество содержимого» AgregationCount)

### 3.3 Алгоритмы и бизнес-логика

#### 3.3.1 Алгоритм обработки входящих событий из Infor

**Пакеты:** MERC - Интеграция RabbitMQ-Infor ordershipped9, dropidshipped9

**Псевдокод:**

```
ДЛЯ КАЖДОГО сообщения из очереди RabbitMQ:
  ЕСЛИ тип события = ordershipped9 ИЛИ dropidshipped9 ИЛИ customerorderpacked9 ИЛИ dropidpacked9:
    
    ДЛЯ КАЖДОЙ строки товара в XML (раздел DropIdDetail):
      ПРОЧИТАТЬ теги: SKU, GTIN, Qty
      
      // Получить карточку товара
      ЗАГРУЗИТЬ InventTable через существующий метод InventTable::findItemId_Infor(SKU)
      ЗАГРУЗИТЬ MPProductGroup через существующий метод MPProductGroup::findByGroupId(InventTable.MPGroupId)
      
      // Проверка: тег GTIN заполнен или пуст
      ЕСЛИ тег <GTIN> заполнен:
        
        // Проверка признаков товара
        // ОСУ/выбытие = наличие хотя бы одного признака: "Объёмно-сортовой учет для продаж" или "Выбытие из организации"
        ЕСЛИ InventTable НЕ имеет признака ОСУ/выбытия (отсутствуют оба признака):
          // Товар обычный, не писать в GTINFromInfor
          ОБРАБОТАТЬ по существующему алгоритму ПУ
          ПЕРЕЙТИ к следующей строке
        
        // Получить уровень проверки (паттерн из раздела 1.2.1)
        MPCodeCheckType checkType = MPParameters::find().MPCodeCustPickingListCheckType;
        
        if (checkType == MPCodeCheckType::NoCheck)
        {
            // Продолжить обработку без проверок
        }
        else
        {
            // Проверка параметра товарной группы
            ЕСЛИ MPProductGroup.isAcceptGTINFromInfor = Нет:
              errorStr = strFmt("В заказе %1 по артикулу %2 получен GTIN, но параметр товарной группы %3 запрещает его обработку", ...);
              if (checkType == MPCodeCheckType::Warning)
                  warning(errorStr);
              else
              {
                  error(errorStr);
                  throw error("@SYS21533");
              }
              ПЕРЕЙТИ к следующей строке
            
            // Валидация формата GTIN
            ЕСЛИ НЕ MATCH(значение из тега GTIN, "^\d{14}$"):  // 14 цифр
              errorStr = strFmt("В заказе %1 значение GTIN %2 по артикулу %3 не соответствует формату EAN/UCC-14", ...);
              if (checkType == MPCodeCheckType::Warning)
                  warning(errorStr);
              else
              {
                  error(errorStr);
                  throw error("@SYS21533");
              }
              ПЕРЕЙТИ к следующей строке
        }
        
        // Проверка существующего GTIN 
        // ЗАГРУЗИТЬ InventItemGTIN ПО ItemId = InventTable.ItemId (полученного через существующий метод InventTable::findItemId_Infor(SKU))
        // Найти запись в таблице InventItemGTIN
        // Получить значение GTIN из реквизита InventItemGTIN.GlobalTradeItemNumber
        // Сравнить полученный GTIN из InventItemGTIN.GlobalTradeItemNumber со значением GTIN из тега <GTIN>
        // При отсутствии записи в InventItemGTIN или несовпадении GTIN: вывести ошибку «GTIN %1 отсутствует в таблице “Коды GTIN” по артикулу %2, заказ %3» (метка  @MIK14634). Применение проверки выполняется по паттерну уровня проверки (см. раздел 1.2.1) с использованием `MPCodeCheckType checkType = MPParameters::find().MPCodeCustPickingListCheckType` в методах обработки очереди Rabbit (классы RabbitIntEngineImp_Infor и их наследники)
        
        // Запись данных (сначала все проверки, в т.ч. подсчёт по SKU — пункт 4 раздела 1.2.3):
        // Записать GTIN из тега <GTIN> в новое поле «GTIN из Infor»
        // Записать количество из тега <Qty> (или сумму Qty по SKU при нескольких строках) в поле «Количество содержимого»
        // Записать запись в MPSalesPurchMarkCodeTable с полями SalesId, ItemId, GTINFromInfor, AgregationCount, ReceiptType = "Sales"
        
        // Логи
        // ЗАПИСАТЬ в лог: "Успешно обработан GTIN %1 для заказа %2, товар %3, количество %4"
      
      ИНАЧЕ ЕСЛИ тег <GTIN> пуст: работать по существующим алгоритмам (неподконтрольный ЧЗ или ПУ — см. пункт 7 раздела 1.2.3)
    
    КОНЕЦ ЦИКЛА по строкам
    
    ЗАВЕРШИТЬ обработку сообщения
  
  КОНЕЦ ЕСЛИ
КОНЕЦ ЦИКЛА по сообщениям
```

#### 3.3.2 Алгоритм формирования УПД с учётом GTIN

**Пакет:** Выгрузка во внешнюю систему → Обмен по ЭДО - Исходящий пакет документов по накладным (продажи)

**Условие входа:** Формирование УПД для заказа на продажу

**Псевдокод:**

```
ЗАГРУЗИТЬ заказ на продажу (SalesTable, SalesLine)

ДЛЯ КАЖДОЙ строки заказа:
  ЗАГРУЗИТЬ товар (InventTable)
  ЗАГРУЗИТЬ группу товара через существующий метод MPProductGroup::findByGroupId(InventTable.MPGroupId)
  
  // Определить тип учёта (признак ОСУ/выбытия = хотя бы один из: "Объёмно-сортовой учет" ИЛИ "Выбытие")
  признак_ОСУ_выбытия := InventTable.имеет признак ОСУ/выбытия
  параметр_группы := MPProductGroup.isAcceptGTINFromInfor
  
  ЕСЛИ признак_ОСУ_выбытия = Нет:
    // Товар обычный, не имеет признаков ОСУ/выбытия
    ФОРМИРОВАТЬ УПД по существующему алгоритму ПУ
    ПЕРЕЙТИ к следующей строке
  
  ЕСЛИ признак_ОСУ_выбытия = Да И параметр_группы = Нет:
    // Проверить наличие GTIN в таблице маркировки
    ЗАГРУЗИТЬ записи из MPSalesPurchMarkCodeTable ПО:
      SalesId = текущий заказ
      ItemId = товар
    
    ЕСЛИ запись содержит GTINFromInfor (не пусто):
      ВЫБРОСИТЬ ошибку «В заказе %1 по артикулу %2 обнаружен GTIN, по товарной группе %3 отражение GTIN в УПД запрещено»
      ПЕРЕЙТИ к следующей строке
    
    ЕСЛИ GTIN не найден: работать по существующему алгоритму ПУ
    ПЕРЕЙТИ к следующей строке
  
  ЕСЛИ признак_ОСУ_выбытия = Да И параметр_группы = Да:
    // Проверить наличие GTIN
    ЗАГРУЗИТЬ запись из MPSalesPurchMarkCodeTable ПО:
      SalesId = текущий заказ
      ItemId = товар
    
    ЕСЛИ запись.GTINFromInfor НЕ пусто:
      // Формировать УПД в режиме ОСУ
      - В тег ГТИН записать значение из «GTIN из Infor»
      - В тег КолВедМарк записать количество из поля «Количество содержимого» таблицы MPSalesPurchMarkCodeTable
    ИНАЧЕ ЕСЛИ запись.GTINFromInfor пусто:
      // Формировать УПД в режиме ПУ (по существующему алгоритму с марками)
  
  КОНЕЦ ЕСЛИ проверок ОСУ/ПУ
КОНЕЦ ЦИКЛА по строкам

// Финальные проверки
ПРОВЕРКА #1: запретить смешивание типов в документе:
  ДЛЯ КАЖДОГО товара:
    ЕСЛИ существуют строки с ПУ И строки с GTIN одновременно:
      ВЫБРОСИТЬ ошибку «В заказе %1 на артикул %2 указано больше одного вида учёта: и ПУ (марки), и ОСУ (GTIN)» (метка @MIK14635)

- КОНЕЦ ЦИКЛА
```

#### 3.3.3 Алгоритм обновления статусов маркировки в заказах

**Периодическая операция:** Обновление статусов маркировок в заказах на продажу
**Класс обработки:** MPMarkingStatusUpdateSalesRunBase 
**Условие входа:** Запуск пакета (вручную или по расписанию)

**Логика определения статуса:**

```
ЗАГРУЗИТЬ все заказы на продажу

ДЛЯ КАЖДОГО заказа:
  
  // Проверить наличие товаров с признаком ОСУ/выбытия
  ЕСЛИ заказ НЕ содержит товаров с признаком ОСУ/выбытия (отсутствуют оба признака: нет «ОСУ для продаж» и нет «Выбытие из организации»): работать по существующему алгоритму
  2. Если товар имеет признак ОСУ/выбытия, но «Параметр» = Нет: работать по существующему алгоритму
  3. Если «Параметр» = Да:
     - Выполнить поиск товара в таблице MPSalesPurchMarkCodeTable по:
       - Номеру заказа на продажу
       - Связь через финансовую накладную к отгрузочной накладной
     - Если в таблице заполнено поле «Код маркировки» (MPCode): работать по алгоритму ПУ
     - Если заполнено поле «GTIN из Infor»: выполнить корректировку поля «Количество содержимого»
     - Если оба поля пусты: работать по существующему алгоритму


  // Подсчитать маркировку (ПУ и GTIN)
  кол_ПУ := СУММА AgregationCount строк, где Код_маркировки НЕ пусто
  кол_GTIN := СУММА AgregationCount строк, где GTINFromInfor НЕ пусто
  кол_заказ := Количество в строках SalesLine
  
  ЕСЛИ кол_ПУ = 0 И кол_GTIN = 0:
    УСТАНОВИТЬ статус = "Не загружены маркировки"
  ИНАЧЕ ЕСЛИ (кол_ПУ + кол_GTIN) < кол_заказ:
    УСТАНОВИТЬ статус = "Загружены частично маркировки"
  ИНАЧЕ ЕСЛИ (кол_ПУ + кол_GTIN) = кол_заказ:
    УСТАНОВИТЬ статус = "Загружены маркировки из ВС"
  СОХРАНИТЬ статус в таблицу статусов маркировки (MPMarkingStatus)

КОНЕЦ ЦИКЛА
```

#### 3.3.4 Алгоритм разноски накладных с проверками

**Применение:** Классы разноски накладных AX 2012

**Входные параметры:**
- Уровень проверки: значение из параметров маркировки (поля «Проверка накладных продаж», «Проверка отгрузочных накладных»)
  - Нет (MPCodeCheckType::NoCheck)
  - Предупреждение (MPCodeCheckType::Warning)
  - Ошибка (MPCodeCheckType::Mistake)

**Логика (с применением единого паттерна уровня проверки из раздела 1.2.1):**

```
ФУНКЦИЯ RaznoskaWithChecks(Накладная, UrList, boolean _throw = false):
модифицируем метод checkMPCode класса SalesFormletterParmDataInvoice.checkMPCode  
  // Получить уровень проверки по паттерну из раздела 1.2.1
  MPCodeCheckType checkType = MPParameters::find().MPCodeCustInvoiceCheckType; // для разноски УПД и исправительных накладных клиента
  
  // В начале реализации метода проверки
  if (checkType == MPCodeCheckType::NoCheck)
  {
      return true;
  }
  
  // Провести проверки маркировки и GTIN
  ДЛЯ КАЖДОЙ строки накладной:
    ЗАГРУЗИТЬ товар (InventTable)
    ЗАГРУЗИТЬ группу товара через существующий метод MPProductGroup::findByGroupId(InventTable.MPGroupId)
    ЗАГРУЗИТЬ записи маркировки из MPSalesPurchMarkCodeTable
    
    // ПРОВЕРКА 1: Параметр группы и наличие GTIN
    ЕСЛИ товар.имеет признак ОСУ/выбытия = Да И группа.isAcceptGTINFromInfor = Нет И запись.GTINFromInfor НЕ пусто:
      errorStr = strFmt("Товар %1, заказ %2: запрещена обработка GTIN для этой группы", ...);
      // В месте применения проверки по паттерну из раздела 1.2.1
      if (checkType == MPCodeCheckType::Warning)
          warning(errorStr);
      else
      {
          error(errorStr);
          if (_throw)
              throw error("@SYS21533");
      }
    
    // ПРОВЕРКА 2: Формат GTIN
    ЕСЛИ запись.GTINFromInfor НЕ пусто:
      ЕСЛИ НЕ MATCH(запись.GTINFromInfor, "^\d{14}$"):
        errorStr = strFmt("Товар %1, заказ %2: неверный формат GTIN %3", ...);
        if (checkType == MPCodeCheckType::Warning)
            warning(errorStr);
        else
        {
            error(errorStr);
            if (_throw)
                throw error("@SYS21533");
        }
    
    // ПРОВЕРКА 3: Запрет смешивания типов учёта
    ЕСЛИ запись содержит ОДНОВРЕМЕННО Код_маркировки И GTINFromInfor:
      errorStr = strFmt("Товар %1, заказ %2: смешивание типов учёта (ПУ и GTIN) запрещено", ...);
      if (checkType == MPCodeCheckType::Warning)
          warning(errorStr);
      else
      {
          error(errorStr);
          if (_throw)
              throw error("@SYS21533");
      }
  
  КОНЕЦ ЦИКЛА
  
  // Если дошли до этого места, проверки пройдены или были предупреждения
  ВЫПОЛНИТЬ разноску
  ВЕРНУТЬ успех

КОНЕЦ ФУНКЦИИ
```

---

## 4. ОТКРЫТЫЕ ВОПРОСЫ И УТОЧНЕНИЯ

| № | Вопрос | Варианты | Статус |
|----|--------|----------|--------|
| 1 | Количество GTIN на один товар в заказе | 1. Только один GTIN на товар в заказе 2. Несколько GTIN по правилам УПД (требует уточнения с УПД) | **АХ принимает всегда только 1 GTIN. Если в XML на 1 SKU >1 GTIN, то взять первый, о том, что их больше 1 записать в инфолог и обработать документ. Если включена активация модификаций, то выводить ошибку* |
| 2 | Параметр контроля GTIN | 1. Один параметр (Принимать GTIN) 2. Два параметра отдельно (допуск и запрет в УПД) | **Не актуально** |
| 3 | Обработка УоУ | 1. Реализовать (требует ресурсов) 2. Отложить на этап 2 (текущее) | **Не реализовываем, не согласовано** |
| 4 | Логическая ошибка при смешивании типов | 1. Выводить как ошибка при разноске независимо от уровня 2. Подчиняться уровню проверки разноски | **Вывести всю логику на существующую (уровни проверок)** |
| 5 | Связь с финансовой накладной в исправительных | 1. Использовать существующий механизм связи 2. Создать новый механизм сопоставления | **Используем текущий** |

---

## 5. ТЕХНИЧЕСКИЕ ПАРАМЕТРЫ И ОГРАНИЧЕНИЯ

### 5.1 Ограничения AX 2012

1. **GTIN формат:** Строго 14 символов, только цифры (EAN/UCC-14, стандарт)
2. **Таблица маркировки:** Максимальный размер записей зависит от конфигурации БД; рекомендуется индексирование по часто используемым полям (SalesId, ItemId, GTINFromInfor)
3. **Производительность:** При обработке массовых входящих сообщений рекомендуется многопоточная обработка (уже реализована в пакете)
4. **XML парсинг:** Используемые пакеты должны поддерживать тег `<GTIN>` в разделе DropIdDetail и тег `<Qty>`; если уже поддерживаются, доработка минимальна

### 5.2 Зависимости между компонентами

```
MPSalesPurchMarkCodeTable (новое поле GTINFromInfor)
  ↓
MPProductGroup («Новый параметр» isAcceptGTINFromInfor). Связь с товаром через InventTable.MPGroupId. Метод MPProductGroup::findByGroupId(InventTable.MPGroupId) существует и используется для получения параметров товарной группы
  ↓
Пакеты обработки входящих событий (MERC - Интеграция RabbitMQ-Infor)
  ↓
Пакеты формирования УПД (XMLExcelReport_UTD_XML)
  ↓
Классы разноски накладных (PurchFormLetter, SalesFormLetter)
  ↓
Периодическая операция обновления статусов маркировки в заказах на продажу
```

### 5.3 Производительность и оптимизация

1. **Индексирование таблицы MPSalesPurchMarkCodeTable:**
   - Рекомендуется индекс: (SalesId, ItemId, GTINFromInfor) для быстрого поиска по заказу и товару
   - Дополнительный индекс: (ReceiptType) для фильтрации по типу (Продажи/Покупки)

2. **Кеширование параметров групп:**
   - Параметр isAcceptGTINFromInfor может кешироваться на уровне сессии для ускорения повторных проверок

3. **Батч-обработка:**
   - Входящие сообщения обрабатываются пакетами; рекомендуется оставить существующий механизм многопоточности

---

## 6. СПИСОК ЗАДАЧ ДЛЯ РАЗРАБОТКИ

### Основные задачи (обязательные)

- [ ] **Задача 1:** Добавить параметр «Принимать GTIN из Infor как ОСУ» в таблицу MPProductGroup и на форму
- [ ] **Задача 2:** Добавить поле «GTIN из Infor» в таблицу MPSalesPurchMarkCodeTable
- [ ] **Задача 3:** Доработать пакеты обработки входящих событий (ordershipped9, dropidshipped9, customerorderpacked9, dropidpacked9) с проверками GTIN и валидацией формата
- [ ] **Задача 4:** Модифицировать пакет формирования УПД с учётом нового параметра и поля GTIN
- [ ] **Задача 5:** Модифицировать пакет формирования ИУПД (аналогично УПД)
- [ ] **Задача 6:** Обновить алгоритм разноски накладных с проверками GTIN и параметра группы
- [ ] **Задача 7:** Обновить периодическую операцию обновления статусов маркировки с учётом GTIN

### Дополнительные задачи (по мере возможности)

- [ ] **Задача 9 (доп.):** Доработать форму «Создать» для Прихода/Расхода «Продажи» в таблице MPSalesPurchMarkCodeTable (добавить чекбокс GTIN, поле ввода, валидацию, взаимное исключение, поле количества)
- [ ] **Задача 10 (доп.):** Добавить кнопку «Заменить GTIN из Infor по строке» на форму Коды маркировок по заказам с функциональностью замены GTIN в строке
